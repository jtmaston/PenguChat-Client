#:import C kivy.utils.get_color_from_hex
#:import RiseInTransition kivy.uix.screenmanager.RiseInTransition
#:import SlideTransition kivy.uix.screenmanager.SlideTransition
#:import FadeTransition kivy.uix.screenmanager.FadeTransition
#:import Window kivy.core.window.Window
#:import Factory kivy.factory.Factory
#:import utils kivy.utils
#:import math math

<MessageBubble>
	size_hint: None, None
	padding: 10, 5
	spacing: 0, 0
    size: self.texture_size

<FileBubble>
    size_hint: None, None
	size: 120, 120

<Label>:
	font_size: "25dp"

<RightButton>
	size_hint_y: None
	size_hint_x: None
	padding: (20, 5)
    height: 40
    width: 40
    text_size: self.width, None

    canvas.before:
        Color:
            rgb: 0.096, 0.535, 0.656
        RoundedRectangle:
            radius: [(15, 15), (15, 15), (15, 15), (15, 15)]
            size: self.texture_size
            pos: self.pos

<MenuButton>:
    background_normal: 'assets/fallback.png'
	background_color: 0, 0.413, 0.586
	canvas.before:
        Color:
            rgb: 0, 0.213, 0.286
        Line:
            width: 2
            rectangle: self.x, self.y, self.width, self.height
<MenuIconButton@MDIconButton>:
    background_normal: 'assets/fallback.png'
	background_color: 0, 0.413, 0.586
	canvas.before:
        Color:
            rgb: 0, 0.213, 0.286
        Line:
            width: 2
            rectangle: self.x, self.y, self.width, self.height


<PortraitScreen@MDScreen>:
    md_bg_color: utils.get_color_from_hex('#ff9f1e')
    on_pre_enter:
        Window.size = (500, 750)
    on_leave:
        app.root.ids.loginUsr.text = ""
        app.root.ids.loginPass.text = ""

    Image:
        source:'Assets/Logo.png'
        pos_hint: {'center_x': 0.5, 'center_y': 0.83}
        size_hint: 0.75, 0.4

    MDLabel:
        font_name: 'Assets/Shrikhand-Regular'
        text: "Welcome to PenguChat!"
        pos_hint: {'center_x': 0.5, 'center_y': 0.70}
        size_hint: 1, None
        height: "30dp"
        halign: 'center'

<BackgroundContainer>
	canvas.before:
	    Color:
	        rgb: 0, 0.213, 0.286
	    Rectangle:
	        pos: self.pos
	        size: self.size

<LoginField@MDTextFieldRound>
    normal_color: utils.get_color_from_hex("e7e7e7")
    pos_hint: {"center_x": .5, "center_y": .5}
    write_tab: False
    multiline: False

<ContactName>
    size_hint: (1 , 1)
    halign: 'center'
    valign: 'center'
    Image:
        source: 'Assets/logo.png'
        pos: self.parent.pos

ScreenManager:
	transition: SlideTransition(direction="up")
	#transition: FadeTransition()
	PortraitScreen:
	    name:'loading_screen'
	    MDSpinner:
            size_hint: None, None
            size: dp(80), dp(80)
            pos_hint: {'center_x': .5, 'center_y': .5}
            active: True

    PortraitScreen:
        name: 'login'
        on_enter:
            app.root.transition = FadeTransition()

        on_leave:
            app.root.ids.loginUsr.text = ""
            app.root.ids.loginPass.text = ""

        MDCard:                     # CARD
            size_hint: .95, 0.5
            pos_hint: {"center_x": .5, "center_y": .30}
            radius: (60, 60, 60, 60)
            orientation: 'vertical'
            MDBoxLayout:                    # Login / Sign up Buttons
                orientation: 'horizontal'
                size_hint: (1, 0.1)
                pos_hint: {"center_x": .5, "center_y": .7}
                #canvas.before:
                #    Color:
                #        rgba: 1, 0, 0, 0
                #    Line:
                #        width: 3
                #        rectangle: self.x, self.y, self.width, self.height
                MDTextButton:
                    text: 'Login'
                    bold: True
                    font_name: 'Assets/Segoe UI Bold'
                    size_hint: (.5, 1)
                    halign: 'center'
                    disabled: True

                MDSeparator:
                    orientation: 'vertical'
                    width: '2dp'
                MDTextButton:
                    text: 'Sign up'
                    font_name: 'Assets/Segoe UI'
                    size_hint: (.5, 1)
                    halign: 'center'
                    on_press:
                        app.root.transition = SlideTransition()
                        app.root.transition.direction = 'left'
                        app.root.current = 'signup'
            MDBoxLayout:
                orientation: 'vertical'
                size_hint: (1, 0.9)
                spacing: 10

                Widget:
		            size_hint: (1, 0.1)
                LoginField:
                    id: loginUsr
                    icon_left: "account"
                    hint_text: 'Username'
                    size_hint: (0.8, 0.15)
                    #radius: (30, 30, 30, 30)
                Widget:
		            size_hint: (1, 0.1)
                LoginField:
                    id: loginPass
                    icon_left: "lock"
                    hint_text: 'Password'
                    size_hint: (0.8, 0.15)
                    password: True
					on_text_validate:
					    app.send_login_data()

		        Widget:
		            size_hint: (1, 0.1)

                MDFillRoundFlatButton:
                    text: " " * 30 + 'Login!' + " " * 30
                    size_hint: (None, 0.15)
                    md_bg_color: utils.get_color_from_hex('#ff9f1e')
                    pos_hint: {'center_x': .5, 'center_y': .5}
                    on_press:
					    app.send_login_data()

                Widget:
                    size_hint: (1, 0.25)

    PortraitScreen:
        name: 'signup'
        on_enter:
            app.root.transition = FadeTransition()
        on_leave:
            app.root.ids.passwd.text = ""
            app.root.ids.passwd_r.text = ""
            app.root.ids.username.text = ""
        MDCard:                     # CARD
            size_hint: .95, 0.5
            pos_hint: {"center_x": .5, "center_y": .30}
            radius: (60, 60, 60, 60)
            orientation: 'vertical'
            MDBoxLayout:                    # Login / Sign up Buttons
                orientation: 'horizontal'
                size_hint: (1, 0.1)
                pos_hint: {"center_x": .5, "center_y": .7}
                #canvas.before:
                #    Color:
                #        rgba: 1, 0, 0, 0
                #    Line:
                #        width: 3
                #        rectangle: self.x, self.y, self.width, self.height
                MDTextButton:
                    text: 'Login'
                    bold: True
                    font_name: 'Assets/Segoe UI'
                    size_hint: (.5, 1)
                    halign: 'center'
                    on_press:
                        app.root.transition = SlideTransition()
                        app.root.transition.direction = 'right'

                        app.root.current = 'login'

                MDSeparator:
                    orientation: 'vertical'
                    width: '2dp'
                MDTextButton:
                    text: 'Sign up'
                    font_name: 'Assets/Segoe UI BOLD'
                    size_hint: (.5, 1)
                    halign: 'center'
                    disabled: True

            MDBoxLayout:
                orientation: 'vertical'
                size_hint: (1, 0.9)
                spacing: 10

                Widget:
		            size_hint: (1, 0.05)
                LoginField:
                    id: username
                    icon_left: "account"
                    hint_text: 'Username'
                    size_hint: (0.8, 0.15)
                    #radius: (30, 30, 30, 30)
                Widget:
		            size_hint: (1, 0.05)
                LoginField:
                    id: passwd
                    icon_left: "lock"
                    hint_text: 'Password'
                    size_hint: (0.8, 0.15)
                    password: True

                Widget:
                    size_hint: (1, 0.05)

                LoginField:
                    id: passwd_r
                    icon_left: "lock"
                    hint_text: 'Password ( repeat )'
                    size_hint: (0.8, 0.15)
                    password: True
					on_text_validate:
					    app.send_sign_up_data()

                Widget:
                    size_hint: (1, 0.05)

                MDFillRoundFlatButton:
                    text: " " * 30 + 'Sign up!' + " " * 30
                    size_hint: (None, 0.15)
                    md_bg_color: utils.get_color_from_hex('#ff9f1e')
                    pos_hint: {'center_x': .5, 'center_y': .5}

		        Widget:
                    size_hint: (1, 0.25)

	PortraitScreen:
	    name:'calling'
	    BoxLayout:
		    padding: 10
	        spacing: 10
			orientation: 'vertical'
			GridLayout:
			    rows: 1
                cols: 2
                spacing: 10
                row_default_height: 90
                row_force_default: True

                MDIconButton:
                    #size_hint: 1., None
                    icon: 'phone-hangup'
                    font_size: 30
                    height: 90
                    on_press: app.end_call()


    PortraitScreen:
	    name:'call_incoming'
	    BoxLayout:
		    padding: 10
	        spacing: 10
			orientation: 'vertical'
			GridLayout:
			    rows: 2
                cols: 1
                spacing: 10
                row_default_height: 90
                row_force_default: True
                MDIconButton:
                    #size_hint: 1., None
                    icon: 'phone-hangup'
                    font_size: 30
                    height: 90
                    #size_hint: (1, None)
                    background_normal: 'assets/fallback.png'
                    background_color: 1, 0, 0
                    on_press: app.root.current = 'chat_room'
                MDIconButton:
                    #size_hint: 1., None
                    icon: 'phone'
                    font_size: 30
                    height: 90
                    #size_hint: (1, None)
                    background_normal: 'assets/fallback.png'
                    background_color: 1, 0, 0
                    on_press: app.root.current = 'calling'

    PortraitScreen:
	    name:'call_failed'
	    BoxLayout:
		    padding: 10
	        spacing: 10
			orientation: 'vertical'
			GridLayout:
			    rows: 1
                cols: 2
                spacing: 10
                row_default_height: 90
                row_force_default: True

    MDScreen:
        md_bg_color: utils.get_color_from_hex("e4e5e9")
        on_enter:
			Window.size = (app.window_size[0], app.window_size[1])
			Window.left = app.chatroom_pos[0]
			Window.top = app.chatroom_pos[1]
			app.init_chat_room()
		name: 'chat_room'

        BoxLayout:
            orientation: 'horizontal'
            size_hint: (1, 1)
            padding: (0, 0, 30, 0)
            MDCard:
                size_hint: (0.25, 1)
                md_bg_color: utils.get_color_from_hex("44525b")
                radius: (0, 45, 45, 0)
                BoxLayout:
                    orientation: 'vertical'
                    size_hint: (1,1)
                    padding: ('15dp' , 0, 0, 0)
                    Widget:
                        size_hint: 1, None
                        height: '50dp'

                    MDLabel:
                        text: "  PenguChat"
                        font_name: 'Assets/Shrikhand-Regular'
                        theme_text_color: "Custom"
                        text_color: utils.get_color_from_hex("ff9f1e")
                        font_size: '25dp'
                        size_hint: (1, None)
                        height: '25dp'
                        halign: 'left'

                    Widget:
                        size_hint: 1, None
                        height: '25dp'

                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint: (1, None)
                        height: '75dp'
                        MDTextButton:
                            id: conversation_button
                            text: "Conversations"
                            font_name: 'Assets/Segoe UI Bold'
                            color: utils.get_color_from_hex("ff9f1e")
                            size_hint: (0.5, 1)
                            font_size: self.width / 7
                            pos_hint: {"center_x": .5, "center_y": .5}
                            halign: 'center'
                            valign: 'top'
                            on_press:
                                app.set_sidebar_to_friend_list()

                        MDSeparator:
                            orientation: 'vertical'
                            width: '1dp'
                            color: utils.get_color_from_hex("5f6c74")
                            size_hint: (None, 0.75)
                            pos_hint: {"center_x": .5, "center_y": .5}

                        MDTextButton:
                            id: requests_button
                            size_hint: (0.5, 1)
                            font_name: 'Assets/Segoe UI'
                            text: 'Requests [ 2 ]'
                            color: utils.get_color_from_hex("e4e5e9")
                            font_size: self.width / 7
                            pos_hint: {"center_x": .5, "center_y": .5}
                            halign: 'center'
                            valign: 'top'
                            on_press:
                                app.set_sidebar_to_request_list()
                    Widget:
                        size_hint: (1, None)
                        height: '25dp'

                    MDSeparator:
                        orientation: 'horizontal'
                        width: '1dp'
                        size_hint: (0.85, None)
                        pos_hint: {"center_x": .5, "center_y": .5}
                        color: utils.get_color_from_hex("5f6c74")
                    ScrollView:
                        MDGridLayout:
                            id: sidebar
                            adaptive_height: True
                            row_default_height: '100dp'
                            row_force_default: True
                            spacing: 0, 5
                            rows: 0
                            cols: 1

                    MDSeparator:
                        orientation: 'horizontal'
                        width: '1dp'
                        size_hint: (0.85, None)
                        pos_hint: {"center_x": .5, "center_y": .5}
                        color: utils.get_color_from_hex("5f6c74")

                    Widget:
                        size_hint: (1, None)
                        height: '65dp'

            BoxLayout:
                orientation: 'vertical'
                size_hint: (0.65, 1)
                padding: ('10dp', 0, 0, '20dp')
                id: conversation_box
                BoxLayout:
                    ScrollView:
                        id: conversation_scroll
                        MDGridLayout:

                            adaptive_height: True
                            id: conversation
                            cols: 1
                            rows: 0
                            spacing: 0, 10
                            padding: 0, 10

                TextInput:
                    id: message_content
                    font_size: '20dp'
                    background_color: 0,0,0,0
                    #cursor_color: C('#000000')
                    size_hint: (1, None)
                    pos_hint: {"center_x": .5, "center_y": .5}
                    height: '20dp' if self.minimum_height == 0 else (self.minimum_height if self.minimum_height < 100 else 100)
                    multiline: True
                    canvas.before:
                        Color:
                            rgba: 1, 1, 1, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [(10, 10), (10, 10), (10, 10), (10, 10)]

                        Color:
                            rgb: C('#000000')



            BoxLayout:
                orientation: 'vertical'
                size_hint: (0.05, 1)
                Widget:
                    size_hint: (1, 1)
                    canvas.before:
                        Color:
                            rgba: 1, 0, 1, 1
                        Line:
                            width: 3
                            rectangle: self.x, self.y, self.width, self.height



	Screen:
		on_enter:
			Window.size = (app.window_size[0], app.window_size[1])
			app.init_chat_room()

		on_leave:
		    app.hide_tk()

		name: 'chat_room_old'
		BoxLayout:
		    orientation: 'vertical'
            BackgroundContainer:
                orientation: 'horizontal'
                padding: 5
                spacing: 5
                BoxLayout:
                    size_hint_x: 0.3
                    orientation: 'vertical'

                    BackgroundContainer:
                        #id: top_bar
                        height: 40
                        orientation: 'horizontal'
                        size_hint: (1, None)
                        padding: 0, 0, 0, 2

                        MenuButton:
                           # id: request_button
                            width: 40
                            text: '2\n'
                            line_height:0.4
                            bold: True
                            font_size: 15
                            halign: 'center'
                            Image:
                                #id: req
                                source: 'Assets/requests.png'
                                size: self.parent.size
                                pos: (self.parent.pos[0] - 1, self.parent.pos[1])

                        MenuButton:
                            width: 40
                            on_press: app.logout()
                            Image:
                                source: 'Assets/logout.png'
                                size: self.parent.size
                                pos: self.parent.pos
                        MenuButton:
                            width: 40
                            on_press: app.new_chat()
                            Image:
                                source: 'Assets/new_convo.png'
                                size: self.parent.size
                                pos: self.parent.pos

                    ScrollView:

                        GridLayout:
                            size_hint_y: None
                            height: self.minimum_height
                            cols: 1
                            rows: 0
                            row_default_height: '100dp'
                            row_force_default: True
                            spacing: 0, 5
                            #id: sidebar

                BoxLayout:
                    padding: (1,0,0,0)
                    orientation: 'vertical'
                    canvas.before:
                        Color:
							rgb: 1, 1, 1
						Rectangle:
							source:"assets/large-wallpaper.png"
							pos: self.pos
							size: self.size
					ScrollView:
					    do_scroll_x: False
					    do_scroll_y: True

						GridLayout
							#id: conversation
							size_hint_y: None
                            cols: 1
                            rows: 0
                            spacing: 0, 10
                            padding: 0, 10

                    BoxLayout:
                        padding: 0
                        spacing: 0
                        #id: message_box
                        height: 50
                        orientation: 'horizontal'
                        size_hint: (1, None)
                        TextInput:
                            padding: 20, 0
                            canvas.before:
                                Color:
                                    rgb: 0, 0.213, 0.286
                                Line:
                                    width: 0.5
                                    rectangle: self.x, self.y, self.width, self.height
                           # id: message_content
                            on_text_validate: app.send_text()
                        MenuButton:
                           # id: send_button
                            on_press: app.send_text()
                            size_hint: (0.15, 1)
                            Image:
                                source: 'Assets/send.png'
                                size: self.parent.size
                                pos: self.parent.pos
                        MenuButton:
                            #id: attach_button
                            on_press: app.send_file()
                            size_hint: (0.15, 1)
                            Image:
                                source: 'Assets/attach.png'
                                size: self.parent.size
                                pos: self.parent.pos
                          #  disabled: True

                        MenuIconButton:
                            icon: 'phone'
                            on_press: app.call(already_in_call=False)